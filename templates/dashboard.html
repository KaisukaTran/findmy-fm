{% extends "base.html" %}

{% block title %}Dashboard – FINDMY FM{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="display-5 fw-bold mb-2">
            <i class="fas fa-chart-line text-primary"></i> FINDMY FM Dashboard
        </h1>
        <p class="text-muted">Trade Service & Statement of Truth Monitor</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="card bg-light border-0">
            <div class="card-body">
                <p class="mb-0 text-muted small">Current Time</p>
                <p class="mb-0 fw-bold" id="current-time">—</p>
            </div>
        </div>
        <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- System Status Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-heartbeat"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-database fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">Database</p>
                            <p class="fw-bold mb-0">✓ Connected</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-exchange-alt fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">Trade Service</p>
                            <p class="fw-bold mb-0">✓ Active</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">SOT Audit</p>
                            <p class="fw-bold mb-0">✓ Ready</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            <p class="mb-0 text-muted">Last Update</p>
                            <p class="fw-bold mb-0" id="last-update">—</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Section -->
<div class="row mb-4" id="summary-cards">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Trades</p>
                <p class="display-6 fw-bold text-primary mb-0" id="total-trades">0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Realized P&L</p>
                <p class="display-6 fw-bold mb-0" id="realized-pnl" style="color: inherit;">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Unrealized P&L</p>
                <p class="display-6 fw-bold mb-0" id="unrealized-pnl" style="color: inherit;">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Equity</p>
                <p class="display-6 fw-bold text-success mb-0" id="total-equity">$0.00</p>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Invested</p>
                <p class="display-6 fw-bold text-info mb-0" id="total-invested">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Market Value</p>
                <p class="display-6 fw-bold text-primary mb-0" id="total-market-value">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small"><i class="fas fa-coins"></i> Price Source</p>
                <p class="fw-bold mb-0 small" id="price-source">Binance (live)</p>
            </div>
        </div>
    </div>
</div>

<!-- Risk Metrics Card (v0.6.0) -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-danger text-white" style="opacity: 0.9;">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Risk Metrics</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">Portfolio Exposure</span>
                            <span id="portfolio-exposure" class="fw-bold">0.0%</span>
                        </div>
                        <div class="progress">
                            <div id="exposure-bar" class="progress-bar bg-info" style="width: 0%"></div>
                        </div>
                        <small class="text-muted d-block mt-1">Max: 10.0% | Current: <span id="exposure-value">0.0%</span></small>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">Today's Loss</span>
                            <span id="daily-loss" class="fw-bold text-danger">$0.00</span>
                        </div>
                        <div class="progress">
                            <div id="loss-bar" class="progress-bar bg-danger" style="width: 0%"></div>
                        </div>
                        <small class="text-muted d-block mt-1">Max Loss: 5.0% | Daily: <span id="daily-loss-pct">0.0%</span></small>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <p class="mb-1"><small><i class="fas fa-info-circle text-info"></i> <strong>Pip Multiplier:</strong> 2.0 (1 pip = 2 × min qty)</small></p>
                    <p class="mb-0"><small><i class="fas fa-info-circle text-info"></i> <strong>Position Limit:</strong> 10% equity | <strong>Daily Loss Limit:</strong> 5% equity</small></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KSS Pyramid Sessions (v0.10.0) -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-purple text-white" style="background-color: #6f42c1 !important;">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-layer-group"></i> KSS Pyramid Sessions</h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#kssCreateModal">
                        <i class="fas fa-plus"></i> New Session
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- KSS Summary -->
                <div class="row g-3 mb-3">
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-2">
                            <p class="mb-0 text-muted small">Active Sessions</p>
                            <p class="fw-bold mb-0 text-primary" id="kss-active-sessions">0</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-2">
                            <p class="mb-0 text-muted small">Total Isolated Fund</p>
                            <p class="fw-bold mb-0 text-info" id="kss-total-fund">$0.00</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-2">
                            <p class="mb-0 text-muted small">Used Fund</p>
                            <p class="fw-bold mb-0" id="kss-used-fund">$0.00</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-2">
                            <p class="mb-0 text-muted small">Unrealized PnL</p>
                            <p class="fw-bold mb-0" id="kss-unrealized-pnl">$0.00</p>
                        </div>
                    </div>
                </div>
                
                <!-- Sessions Table -->
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Symbol</th>
                                <th>Status</th>
                                <th class="text-end">Entry</th>
                                <th class="text-end">Avg Price</th>
                                <th>Waves</th>
                                <th class="text-end">Filled Qty</th>
                                <th class="text-end">TP Target</th>
                                <th class="text-end">PnL</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="kss-sessions-tbody">
                            <tr>
                                <td colspan="10" class="text-center text-muted py-3">
                                    <i class="fas fa-spinner fa-spin"></i> Loading sessions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-kss-sessions" class="alert alert-secondary mt-3 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No KSS sessions. Create one to start pyramid DCA trading!
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KSS Create Session Modal -->
<div class="modal fade" id="kssCreateModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white" style="background-color: #6f42c1 !important;">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> Create Pyramid Session</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left: Form -->
                    <div class="col-md-5">
                        <form id="kss-create-form">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Symbol</label>
                                    <input type="text" class="form-control" id="kss-symbol" value="BTC" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Entry Price</label>
                                    <input type="number" class="form-control" id="kss-entry-price" step="0.01" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Distance %</label>
                                    <input type="number" class="form-control" id="kss-distance-pct" value="2.0" step="0.1" required>
                                    <small class="text-muted">Price drop per wave</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Max Waves</label>
                                    <input type="number" class="form-control" id="kss-max-waves" value="10" min="1" max="100" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Isolated Fund ($)</label>
                                    <input type="number" class="form-control" id="kss-isolated-fund" value="1000" step="0.01" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Take Profit %</label>
                                    <input type="number" class="form-control" id="kss-tp-pct" value="3.0" step="0.1" required>
                                    <small class="text-muted">TP above avg price</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Timeout (min)</label>
                                    <input type="number" class="form-control" id="kss-timeout" value="30" min="1" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Gap Min (min)</label>
                                    <input type="number" class="form-control" id="kss-gap" value="5" min="0" required>
                                </div>
                                <div class="col-12 mt-3">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="previewKSSSession()">
                                        <i class="fas fa-eye"></i> Preview Pyramid
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Right: Preview -->
                    <div class="col-md-7">
                        <div id="kss-preview-area" class="border rounded p-3 bg-light" style="min-height: 300px;">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-eye fa-3x mb-3 opacity-25"></i>
                                <p>Click "Preview Pyramid" to see projected waves</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn text-white" style="background-color: #6f42c1;" onclick="createKSSSession()">
                    <i class="fas fa-plus"></i> Create Session
                </button>
            </div>
        </div>
    </div>
</div>

<!-- KSS Session Detail Modal (v0.10.0 Phase 7) -->
<div class="modal fade" id="kssDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-purple text-white" style="background-color: #6f42c1 !important;">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> Session Detail <span id="kss-detail-title"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Left: Info + Waves Table -->
                    <div class="col-md-6">
                        <!-- Session Summary -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="row g-2 small">
                                    <div class="col-6"><strong>Symbol:</strong> <span id="kss-detail-symbol"></span></div>
                                    <div class="col-6"><strong>Status:</strong> <span id="kss-detail-status"></span></div>
                                    <div class="col-6"><strong>Entry:</strong> <span id="kss-detail-entry"></span></div>
                                    <div class="col-6"><strong>Avg Price:</strong> <span id="kss-detail-avg" class="text-warning fw-bold"></span></div>
                                    <div class="col-6"><strong>Filled Qty:</strong> <span id="kss-detail-qty"></span></div>
                                    <div class="col-6"><strong>TP Target:</strong> <span id="kss-detail-tp" class="text-success fw-bold"></span></div>
                                    <div class="col-6"><strong>Current:</strong> <span id="kss-detail-current" class="text-primary fw-bold"></span></div>
                                    <div class="col-6"><strong>PnL:</strong> <span id="kss-detail-pnl"></span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Waves Table (color-coded) -->
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>#</th>
                                        <th class="text-end">Target</th>
                                        <th class="text-end">Qty</th>
                                        <th>Status</th>
                                        <th class="text-end">Filled At</th>
                                    </tr>
                                </thead>
                                <tbody id="kss-detail-waves-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Right: Chart -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <small><i class="fas fa-chart-line"></i> Price Levels</small>
                            </div>
                            <div class="card-body">
                                <canvas id="kss-detail-chart" style="max-height: 350px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Positions Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> Current Positions</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Symbol</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Avg Price</th>
                                <th class="text-end">Total Cost</th>
                                <th class="text-end">Current Price</th>
                                <th class="text-end">Market Value</th>
                                <th class="text-end">Unrealized P&L</th>
                            </tr>
                        </thead>
                        <tbody id="positions-tbody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading positions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-positions" class="alert alert-info m-3 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No open positions yet.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Orders Section (v0.5.0) -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-hourglass-half"></i> Pending Orders Queue</h5>
                    <span class="badge bg-warning text-dark" id="pending-count">0</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Price</th>
                                <th>Order Type</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th class="text-center" style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-tbody">
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading pending orders...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-pending" class="alert alert-success m-3 mb-0" style="display: none;">
                    <i class="fas fa-check-circle"></i> No pending orders. All orders have been reviewed!
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trade History Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> Trade History (Recent 50)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Timestamp</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Price</th>
                                <th>Status</th>
                                <th class="text-end">Realized P&L</th>
                            </tr>
                        </thead>
                        <tbody id="trades-tbody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading trade history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-trades" class="alert alert-info m-3 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No trades yet. Upload an Excel file to execute orders.
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Update current time
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString();
    }
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    // Format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(value);
    }

    // Format date/time
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
    }

    // Load summary data
    async function loadSummary() {
        try {
            const response = await fetch('/api/summary');
            const data = await response.json();
            
            document.getElementById('total-trades').textContent = data.total_trades;
            
            const realizedColor = data.realized_pnl >= 0 ? '#28a745' : '#dc3545';
            const realizedElement = document.getElementById('realized-pnl');
            realizedElement.textContent = formatCurrency(data.realized_pnl);
            realizedElement.style.color = realizedColor;
            
            const unrealizedColor = data.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
            const unrealizedElement = document.getElementById('unrealized-pnl');
            unrealizedElement.textContent = formatCurrency(data.unrealized_pnl);
            unrealizedElement.style.color = unrealizedColor;
            
            document.getElementById('total-invested').textContent = formatCurrency(data.total_invested);
            document.getElementById('total-market-value').textContent = formatCurrency(data.total_market_value);
            
            const equityColor = data.total_equity >= data.total_invested ? '#28a745' : '#dc3545';
            const equityElement = document.getElementById('total-equity');
            equityElement.textContent = formatCurrency(data.total_equity);
            equityElement.style.color = equityColor;
            
            if (data.last_trade_time) {
                document.getElementById('last-update').textContent = formatDateTime(data.last_trade_time);
            } else {
                document.getElementById('last-update').textContent = '—';
            }
        } catch (error) {
            console.error('Error loading summary:', error);
        }
    }

    // Load positions data
    async function loadPositions() {
        try {
            const response = await fetch('/api/positions');
            const positions = await response.json();
            
            const tbody = document.getElementById('positions-tbody');
            const noPositions = document.getElementById('no-positions');
            
            if (positions.length === 0) {
                tbody.innerHTML = '';
                noPositions.style.display = 'block';
            } else {
                noPositions.style.display = 'none';
                tbody.innerHTML = positions.map(pos => {
                    const pnlColor = pos.unrealized_pnl !== null && pos.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                    const pnlText = pos.unrealized_pnl !== null ? formatCurrency(pos.unrealized_pnl) : '—';
                    const marketValueText = pos.market_value !== null ? formatCurrency(pos.market_value) : '—';
                    const currentPriceText = pos.current_price !== null ? formatCurrency(pos.current_price) : '—';
                    
                    return `
                        <tr>
                            <td><strong>${pos.symbol}</strong></td>
                            <td class="text-end">${pos.quantity.toFixed(8)}</td>
                            <td class="text-end">${formatCurrency(pos.avg_price)}</td>
                            <td class="text-end"><strong>${formatCurrency(pos.total_cost)}</strong></td>
                            <td class="text-end">${currentPriceText}</td>
                            <td class="text-end">${marketValueText}</td>
                            <td class="text-end" style="color: ${pnlColor};"><strong>${pnlText}</strong></td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading positions:', error);
        }
    }

    // Load trades data
    async function loadTrades() {
        try {
            const response = await fetch('/api/trades');
            const trades = await response.json();
            
            const tbody = document.getElementById('trades-tbody');
            const noTrades = document.getElementById('no-trades');
            
            if (trades.length === 0) {
                tbody.innerHTML = '';
                noTrades.style.display = 'block';
            } else {
                noTrades.style.display = 'none';
                tbody.innerHTML = trades.slice(0, 50).map(trade => {
                    const pnlColor = trade.realized_pnl !== null && trade.realized_pnl >= 0 ? '#28a745' : '#dc3545';
                    const pnlText = trade.realized_pnl !== null ? formatCurrency(trade.realized_pnl) : '—';
                    return `
                        <tr>
                            <td><small>${formatDateTime(trade.entry_time)}</small></td>
                            <td><strong>${trade.symbol}</strong></td>
                            <td>
                                <span class="badge ${trade.side === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                    ${trade.side}
                                </span>
                            </td>
                            <td class="text-end">${trade.entry_qty.toFixed(8)}</td>
                            <td class="text-end">${formatCurrency(trade.entry_price)}</td>
                            <td>
                                <span class="badge ${trade.status === 'OPEN' ? 'bg-warning' : (trade.status === 'CLOSED' ? 'bg-success' : 'bg-secondary')}">
                                    ${trade.status}
                                </span>
                            </td>
                            <td class="text-end" style="color: ${pnlColor};">
                                <strong>${pnlText}</strong>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading trades:', error);
        }
    }

    // Load pending orders data (v0.5.0)
    async function loadPendingOrders() {
        try {
            const response = await fetch('/api/pending');
            const orders = await response.json();
            
            const tbody = document.getElementById('pending-tbody');
            const noPending = document.getElementById('no-pending');
            const countBadge = document.getElementById('pending-count');
            
            // Count pending (not approved or rejected)
            const pendingOrders = orders.filter(o => o.status === 'pending');
            countBadge.textContent = pendingOrders.length;
            
            if (pendingOrders.length === 0) {
                tbody.innerHTML = '';
                noPending.style.display = 'block';
            } else {
                noPending.style.display = 'none';
                tbody.innerHTML = pendingOrders.map(order => {
                    const sideBadgeClass = order.side === 'BUY' ? 'bg-success' : 'bg-danger';
                    const statusBadgeClass = order.status === 'pending' ? 'bg-warning text-dark' : (order.status === 'approved' ? 'bg-success' : 'bg-danger');
                    return `
                        <tr>
                            <td><strong>${order.symbol}</strong></td>
                            <td>
                                <span class="badge ${sideBadgeClass}">
                                    ${order.side}
                                </span>
                            </td>
                            <td class="text-end">${order.quantity}</td>
                            <td class="text-end">${formatCurrency(order.price)}</td>
                            <td><small>${order.order_type || 'LIMIT'}</small></td>
                            <td><small>${order.source || 'manual'}</small></td>
                            <td>
                                <span class="badge ${statusBadgeClass}">
                                    ${order.status}
                                </span>
                            </td>
                            <td><small>${formatDateTime(order.created_at)}</small></td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-success" onclick="approvePendingOrder(${order.id}, '${order.symbol}')" title="Approve order">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="rejectPendingOrder(${order.id}, '${order.symbol}')" title="Reject order">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading pending orders:', error);
        }
    }

    // Approve pending order (v0.5.0)
    async function approvePendingOrder(orderId, symbol) {
        if (!confirm(`Approve order for ${symbol}?`)) return;
        
        try {
            const response = await fetch(`/api/pending/approve/${orderId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            if (response.ok) {
                console.log(`Order ${orderId} approved`);
                loadPendingOrders();
                // Refresh positions and trades after approval
                loadPositions();
                loadTrades();
                loadSummary();
            } else {
                alert('Failed to approve order');
            }
        } catch (error) {
            console.error('Error approving order:', error);
            alert('Error approving order');
        }
    }

    // Reject pending order (v0.5.0)
    async function rejectPendingOrder(orderId, symbol) {
        const reason = prompt(`Reject order for ${symbol}? (Enter reason):`, 'Market conditions changed');
        if (reason === null) return;
        
        try {
            const response = await fetch(`/api/pending/reject/${orderId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({reason: reason || 'User rejected'})
            });
            
            if (response.ok) {
                console.log(`Order ${orderId} rejected`);
                loadPendingOrders();
            } else {
                alert('Failed to reject order');
            }
        } catch (error) {
            console.error('Error rejecting order:', error);
            alert('Error rejecting order');
        }
    }

    // Load risk metrics (v0.6.0)
    async function loadRiskMetrics() {
        try {
            // For now, use mock data (in production, fetch from /api/risk endpoint)
            // Portfolio exposure: 5% of equity
            const portfolioExposure = 5.0;
            const maxExposure = 10.0;
            
            // Daily loss: $250 (2.5% of $10k)
            const dailyLoss = 250.0;
            const dailyLossPct = 2.5;
            const maxDailyLoss = 5.0;

            // Update exposure display
            document.getElementById('portfolio-exposure').textContent = portfolioExposure.toFixed(1) + '%';
            document.getElementById('exposure-value').textContent = portfolioExposure.toFixed(1) + '%';
            document.getElementById('exposure-bar').style.width = (portfolioExposure / maxExposure * 100) + '%';
            
            // Color exposure bar based on percentage
            const exposureBar = document.getElementById('exposure-bar');
            if (portfolioExposure > maxExposure * 0.8) {
                exposureBar.className = 'progress-bar bg-danger';
            } else if (portfolioExposure > maxExposure * 0.5) {
                exposureBar.className = 'progress-bar bg-warning';
            } else {
                exposureBar.className = 'progress-bar bg-info';
            }

            // Update daily loss display
            document.getElementById('daily-loss').textContent = formatCurrency(dailyLoss);
            document.getElementById('daily-loss-pct').textContent = dailyLossPct.toFixed(1) + '%';
            document.getElementById('loss-bar').style.width = (dailyLossPct / maxDailyLoss * 100) + '%';
            
            // Color loss bar based on percentage
            const lossBar = document.getElementById('loss-bar');
            if (dailyLossPct > maxDailyLoss * 0.8) {
                lossBar.className = 'progress-bar bg-danger';
            } else if (dailyLossPct > maxDailyLoss * 0.5) {
                lossBar.className = 'progress-bar bg-warning';
            } else {
                lossBar.className = 'progress-bar bg-success';
            }
        } catch (error) {
            console.error('Error loading risk metrics:', error);
        }
    }

    // Initial load
    loadSummary();
    loadPositions();
    loadPendingOrders();
    loadTrades();
    loadRiskMetrics();

    // WebSocket connection for live updates (every 30 seconds from server)
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws/dashboard`);
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'dashboard_update') {
                    console.log('Received dashboard update:', data);
                    // Update positions from WebSocket
                    updatePositionsFromWebSocket(data.positions);
                    // Update summary from WebSocket
                    updateSummaryFromWebSocket(data.summary);
                }
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = function() {
            console.log('WebSocket closed, attempting to reconnect in 5 seconds...');
            setTimeout(connectWebSocket, 5000);
        };
    }
    
    // Update positions from WebSocket data
    function updatePositionsFromWebSocket(positions) {
        const tbody = document.getElementById('positions-tbody');
        const noPos = document.getElementById('no-positions');
        
        if (!positions || positions.length === 0) {
            tbody.innerHTML = '';
            noPos.style.display = 'block';
        } else {
            noPos.style.display = 'none';
            tbody.innerHTML = positions.map(pos => {
                const unrealizedColor = pos.unrealized_pnl !== null && pos.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                const unrealizedText = pos.unrealized_pnl !== null ? formatCurrency(pos.unrealized_pnl) : '—';
                const marketValueText = pos.market_value !== null ? formatCurrency(pos.market_value) : '—';
                const priceText = pos.current_price ? formatCurrency(pos.current_price) : '—';
                return `
                    <tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td class="text-end">${pos.quantity.toFixed(8)}</td>
                        <td class="text-end">${formatCurrency(pos.avg_price)}</td>
                        <td class="text-end">${formatCurrency(pos.total_cost)}</td>
                        <td class="text-end text-info"><strong>${priceText}</strong></td>
                        <td class="text-end text-info"><strong>${marketValueText}</strong></td>
                        <td class="text-end" style="color: ${unrealizedColor};"><strong>${unrealizedText}</strong></td>
                    </tr>
                `;
            }).join('');
        }
    }
    
    // Update summary from WebSocket data
    function updateSummaryFromWebSocket(summary) {
        const totalTradesEl = document.getElementById('total-trades');
        const realizedPnLEl = document.getElementById('realized-pnl');
        const unrealizedPnLEl = document.getElementById('unrealized-pnl');
        const totalInvestedEl = document.getElementById('total-invested');
        const totalMarketValueEl = document.getElementById('total-market-value');
        const totalEquityEl = document.getElementById('total-equity');
        
        if (totalTradesEl) totalTradesEl.textContent = summary.total_trades;
        if (realizedPnLEl) {
            realizedPnLEl.textContent = formatCurrency(summary.realized_pnl);
            realizedPnLEl.style.color = summary.realized_pnl >= 0 ? '#28a745' : '#dc3545';
        }
        if (unrealizedPnLEl) {
            unrealizedPnLEl.textContent = formatCurrency(summary.unrealized_pnl);
            unrealizedPnLEl.style.color = summary.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
        }
        if (totalInvestedEl) totalInvestedEl.textContent = formatCurrency(summary.total_invested);
        if (totalMarketValueEl) totalMarketValueEl.textContent = formatCurrency(summary.total_market_value);
        if (totalEquityEl) {
            totalEquityEl.textContent = formatCurrency(summary.total_equity);
            totalEquityEl.style.color = summary.total_equity >= 10000 ? '#28a745' : '#dc3545';
        }
    }

    // Connect WebSocket for live updates
    connectWebSocket();

    // ==========================================
    // KSS (Kai Strategy Service) Functions v0.10.0
    // ==========================================
    
    // Load KSS sessions
    async function loadKSSSessions() {
        try {
            const response = await fetch('/api/kss/sessions');
            const data = await response.json();
            
            // Update summary
            document.getElementById('kss-active-sessions').textContent = data.active_count || 0;
            document.getElementById('kss-total-fund').textContent = formatCurrency(data.total_isolated_fund || 0);
            
            // Calculate used fund and PnL
            let usedFund = 0;
            let unrealizedPnl = 0;
            (data.sessions || []).forEach(s => {
                if (s.status === 'active') {
                    usedFund += s.used_fund || 0;
                    unrealizedPnl += s.unrealized_pnl || 0;
                }
            });
            document.getElementById('kss-used-fund').textContent = formatCurrency(usedFund);
            const pnlEl = document.getElementById('kss-unrealized-pnl');
            pnlEl.textContent = formatCurrency(unrealizedPnl);
            pnlEl.style.color = unrealizedPnl >= 0 ? '#28a745' : '#dc3545';
            
            // Render sessions table
            const tbody = document.getElementById('kss-sessions-tbody');
            const noSessions = document.getElementById('no-kss-sessions');
            
            if (!data.sessions || data.sessions.length === 0) {
                tbody.innerHTML = '';
                noSessions.style.display = 'block';
            } else {
                noSessions.style.display = 'none';
                tbody.innerHTML = data.sessions.map(session => {
                    const statusBadge = getKSSStatusBadge(session.status);
                    const pnlColor = (session.unrealized_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
                    return `
                        <tr>
                            <td><strong>#${session.id}</strong></td>
                            <td><span class="badge bg-primary">${session.symbol}</span></td>
                            <td>${statusBadge}</td>
                            <td class="text-end">${formatCurrency(session.entry_price)}</td>
                            <td class="text-end">${session.avg_price > 0 ? formatCurrency(session.avg_price) : '—'}</td>
                            <td>${session.filled_waves_count || 0}/${session.max_waves}</td>
                            <td class="text-end">${(session.total_filled_qty || 0).toFixed(6)}</td>
                            <td class="text-end text-success">${formatCurrency(session.estimated_tp_price || 0)}</td>
                            <td class="text-end" style="color: ${pnlColor};">${formatCurrency(session.unrealized_pnl || 0)}</td>
                            <td class="text-center">
                                ${getKSSActions(session)}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading KSS sessions:', error);
        }
    }
    
    function getKSSStatusBadge(status) {
        const badges = {
            'pending': '<span class="badge bg-secondary">Pending</span>',
            'active': '<span class="badge bg-success">Active</span>',
            'stopped': '<span class="badge bg-warning text-dark">Stopped</span>',
            'completed': '<span class="badge bg-info">Completed</span>',
            'tp_triggered': '<span class="badge bg-primary">TP Hit!</span>',
        };
        return badges[status] || `<span class="badge bg-dark">${status}</span>`;
    }
    
    function getKSSActions(session) {
        const viewBtn = `<button class="btn btn-sm btn-outline-secondary me-1" onclick="viewKSSSession(${session.id})" title="View Details">
            <i class="fas fa-eye"></i>
        </button>`;
        
        if (session.status === 'pending') {
            return viewBtn + `
                <button class="btn btn-sm btn-success" onclick="startKSSSession(${session.id})" title="Start">
                    <i class="fas fa-play"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteKSSSession(${session.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            `;
        } else if (session.status === 'active') {
            return viewBtn + `
                <button class="btn btn-sm btn-warning" onclick="stopKSSSession(${session.id})" title="Stop">
                    <i class="fas fa-stop"></i>
                </button>
                <button class="btn btn-sm btn-info" onclick="checkKSSTP(${session.id})" title="Check TP">
                    <i class="fas fa-bullseye"></i>
                </button>
            `;
        } else {
            return viewBtn + `
                <button class="btn btn-sm btn-danger" onclick="deleteKSSSession(${session.id})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            `;
        }
    }
    
    // Create KSS session
    async function createKSSSession() {
        const data = {
            symbol: document.getElementById('kss-symbol').value.toUpperCase(),
            entry_price: parseFloat(document.getElementById('kss-entry-price').value),
            distance_pct: parseFloat(document.getElementById('kss-distance-pct').value),
            max_waves: parseInt(document.getElementById('kss-max-waves').value),
            isolated_fund: parseFloat(document.getElementById('kss-isolated-fund').value),
            tp_pct: parseFloat(document.getElementById('kss-tp-pct').value),
            timeout_x_min: parseFloat(document.getElementById('kss-timeout').value),
            gap_y_min: parseFloat(document.getElementById('kss-gap').value),
        };
        
        try {
            const response = await fetch('/api/kss/sessions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(`Session #${result.id} created! Click Start to begin.`);
                bootstrap.Modal.getInstance(document.getElementById('kssCreateModal')).hide();
                loadKSSSessions();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to create session'));
            }
        } catch (error) {
            console.error('Error creating KSS session:', error);
            alert('Error creating session');
        }
    }
    
    // Start KSS session
    async function startKSSSession(sessionId) {
        if (!confirm(`Start pyramid session #${sessionId}? This will queue wave 0.`)) return;
        
        try {
            const response = await fetch(`/api/kss/sessions/${sessionId}/start`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                alert(`Session started! Wave 0 queued (Order #${result.pending_order_id})`);
                loadKSSSessions();
                loadPendingOrders();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to start session'));
            }
        } catch (error) {
            console.error('Error starting KSS session:', error);
            alert('Error starting session');
        }
    }
    
    // Stop KSS session
    async function stopKSSSession(sessionId) {
        if (!confirm(`Stop pyramid session #${sessionId}?`)) return;
        
        try {
            const response = await fetch(`/api/kss/sessions/${sessionId}/stop`, {
                method: 'POST'
            });
            
            if (response.ok) {
                alert('Session stopped');
                loadKSSSessions();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to stop session'));
            }
        } catch (error) {
            console.error('Error stopping KSS session:', error);
            alert('Error stopping session');
        }
    }
    
    // Delete KSS session
    async function deleteKSSSession(sessionId) {
        if (!confirm(`Delete pyramid session #${sessionId}? This cannot be undone.`)) return;
        
        try {
            const response = await fetch(`/api/kss/sessions/${sessionId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                alert('Session deleted');
                loadKSSSessions();
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to delete session'));
            }
        } catch (error) {
            console.error('Error deleting KSS session:', error);
            alert('Error deleting session');
        }
    }
    
    // Check TP for KSS session
    async function checkKSSTP(sessionId) {
        try {
            const response = await fetch(`/api/kss/sessions/${sessionId}/check-tp`, {
                method: 'POST'
            });
            
            if (response.ok) {
                const result = await response.json();
                if (result.tp_triggered) {
                    alert(`TP TRIGGERED! Sell order queued (Order #${result.pending_order_id})`);
                    loadKSSSessions();
                    loadPendingOrders();
                } else {
                    alert(`TP not triggered yet.\nCurrent: ${formatCurrency(result.current_price)}\nTP Target: ${formatCurrency(result.tp_price)}`);
                }
            } else {
                const error = await response.json();
                alert('Error: ' + (error.detail || 'Failed to check TP'));
            }
        } catch (error) {
            console.error('Error checking KSS TP:', error);
            alert('Error checking TP');
        }
    }
    
    // Load KSS sessions on page load
    loadKSSSessions();

    // ==========================================
    // KSS Phase 7: Preview & Visualization (v0.10.0)
    // ==========================================
    
    let kssDetailChart = null;  // Chart.js instance
    
    // Preview pyramid session without creating
    async function previewKSSSession() {
        const data = {
            symbol: document.getElementById('kss-symbol').value.toUpperCase(),
            entry_price: parseFloat(document.getElementById('kss-entry-price').value),
            distance_pct: parseFloat(document.getElementById('kss-distance-pct').value),
            max_waves: parseInt(document.getElementById('kss-max-waves').value),
            isolated_fund: parseFloat(document.getElementById('kss-isolated-fund').value),
            tp_pct: parseFloat(document.getElementById('kss-tp-pct').value),
        };
        
        // Validate
        if (!data.entry_price || data.entry_price <= 0) {
            alert('Please enter a valid entry price');
            return;
        }
        
        try {
            const response = await fetch('/api/kss/preview', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                const preview = await response.json();
                renderKSSPreview(preview);
            } else {
                const error = await response.json();
                alert('Preview error: ' + (error.detail || 'Failed to preview'));
            }
        } catch (error) {
            console.error('Error previewing KSS session:', error);
            alert('Error generating preview');
        }
    }
    
    // Render preview result in the modal
    function renderKSSPreview(preview) {
        const area = document.getElementById('kss-preview-area');
        
        let html = `
            <div class="mb-3">
                <h6 class="text-muted mb-2"><i class="fas fa-chart-bar"></i> Preview: ${preview.symbol} Pyramid</h6>
                <div class="row g-2 small">
                    <div class="col-6"><strong>Qty/Wave:</strong> ${preview.qty_per_wave.toFixed(6)}</div>
                    <div class="col-6"><strong>Price Range:</strong> ${preview.price_range_pct.toFixed(1)}%</div>
                    <div class="col-6"><strong>Total Qty:</strong> ${preview.total_qty.toFixed(6)}</div>
                    <div class="col-6"><strong>Final Avg:</strong> ${formatCurrency(preview.final_avg_price)}</div>
                    <div class="col-6"><strong>Total Cost:</strong> ${formatCurrency(preview.total_cost)}</div>
                    <div class="col-6"><strong>TP Target:</strong> <span class="text-success fw-bold">${formatCurrency(preview.final_tp_price)}</span></div>
                </div>
            </div>
            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                <table class="table table-sm table-bordered mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th>#</th>
                            <th class="text-end">Target</th>
                            <th class="text-end">Qty</th>
                            <th class="text-end">Cumul Qty</th>
                            <th class="text-end">Avg After</th>
                            <th class="text-end">TP After</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        preview.waves.forEach(w => {
            html += `
                <tr>
                    <td>${w.wave_num}</td>
                    <td class="text-end">${formatCurrency(w.target_price)}</td>
                    <td class="text-end">${w.quantity.toFixed(6)}</td>
                    <td class="text-end">${w.cumulative_qty.toFixed(6)}</td>
                    <td class="text-end text-warning">${formatCurrency(w.avg_price_after)}</td>
                    <td class="text-end text-success">${formatCurrency(w.tp_price_after)}</td>
                </tr>
            `;
        });
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        area.innerHTML = html;
    }
    
    // View session detail with Chart.js visualization
    async function viewKSSSession(sessionId) {
        try {
            const response = await fetch(`/api/kss/sessions/${sessionId}`);
            if (!response.ok) {
                alert('Failed to load session');
                return;
            }
            
            const session = await response.json();
            
            // Populate modal
            document.getElementById('kss-detail-title').textContent = `#${session.id} - ${session.symbol}`;
            document.getElementById('kss-detail-symbol').innerHTML = `<span class="badge bg-primary">${session.symbol}</span>`;
            document.getElementById('kss-detail-status').innerHTML = getKSSStatusBadge(session.status);
            document.getElementById('kss-detail-entry').textContent = formatCurrency(session.entry_price);
            document.getElementById('kss-detail-avg').textContent = session.avg_price > 0 ? formatCurrency(session.avg_price) : '—';
            document.getElementById('kss-detail-qty').textContent = session.total_filled_qty.toFixed(6);
            document.getElementById('kss-detail-tp').textContent = formatCurrency(session.estimated_tp_price);
            document.getElementById('kss-detail-current').textContent = formatCurrency(session.current_price);
            
            const pnlEl = document.getElementById('kss-detail-pnl');
            pnlEl.textContent = `${formatCurrency(session.unrealized_pnl)} (${session.unrealized_pnl_pct.toFixed(2)}%)`;
            pnlEl.style.color = session.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
            
            // Render waves table with color coding
            renderDetailWavesTable(session);
            
            // Render Chart.js price levels
            renderKSSChart(session);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('kssDetailModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error viewing KSS session:', error);
            alert('Error loading session details');
        }
    }
    
    // Render waves table with color coding (green=filled, red=pending)
    function renderDetailWavesTable(session) {
        const tbody = document.getElementById('kss-detail-waves-tbody');
        
        if (!session.waves || session.waves.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No waves generated yet</td></tr>';
            return;
        }
        
        tbody.innerHTML = session.waves.map(wave => {
            const isFilled = wave.status === 'filled';
            const rowClass = isFilled ? 'table-success' : 'table-danger';
            const statusBadge = isFilled 
                ? '<span class="badge bg-success"><i class="fas fa-check"></i> Filled</span>'
                : '<span class="badge bg-danger"><i class="fas fa-clock"></i> Pending</span>';
            
            return `
                <tr class="${rowClass}">
                    <td><strong>${wave.wave_num}</strong></td>
                    <td class="text-end">${formatCurrency(wave.target_price)}</td>
                    <td class="text-end">${wave.quantity.toFixed(6)}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">${wave.filled_price ? formatCurrency(wave.filled_price) : '—'}</td>
                </tr>
            `;
        }).join('');
    }
    
    // Render Chart.js horizontal price lines
    function renderKSSChart(session) {
        const ctx = document.getElementById('kss-detail-chart').getContext('2d');
        
        // Destroy existing chart
        if (kssDetailChart) {
            kssDetailChart.destroy();
        }
        
        // Build data points for wave targets
        const labels = [];
        const targetPrices = [];
        const avgPrices = [];
        const tpPrices = [];
        const currentPrices = [];
        
        // Calculate running avg and TP for each wave (even unfilled)
        let cumulativeQty = 0;
        let cumulativeCost = 0;
        const qtyPerWave = session.isolated_fund / session.max_waves / session.entry_price;
        
        for (let i = 0; i < session.max_waves; i++) {
            const targetPrice = session.entry_price * (1 - session.distance_pct / 100 * i);
            const waveCost = qtyPerWave * targetPrice;
            cumulativeQty += qtyPerWave;
            cumulativeCost += waveCost;
            const avgPrice = cumulativeCost / cumulativeQty;
            const tpPrice = avgPrice * (1 + session.tp_pct / 100);
            
            labels.push(`W${i}`);
            targetPrices.push(targetPrice);
            avgPrices.push(avgPrice);
            tpPrices.push(tpPrice);
            currentPrices.push(session.current_price);
        }
        
        kssDetailChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Wave Target',
                        data: targetPrices,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220,53,69,0.1)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0,
                        pointRadius: 4,
                    },
                    {
                        label: 'Avg Price',
                        data: avgPrices,
                        borderColor: '#ffc107',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        fill: false,
                        tension: 0,
                        pointRadius: 2,
                    },
                    {
                        label: 'TP Target',
                        data: tpPrices,
                        borderColor: '#28a745',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        fill: false,
                        tension: 0,
                        pointRadius: 2,
                    },
                    {
                        label: 'Current Price',
                        data: currentPrices,
                        borderColor: '#007bff',
                        borderWidth: 3,
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                    },
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 15 }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatCurrency(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        title: { display: true, text: 'Price ($)' },
                        ticks: {
                            callback: function(value) { return '$' + value.toLocaleString(); }
                        }
                    },
                    x: {
                        title: { display: true, text: 'Wave' }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // Also keep polling every 60 seconds as fallback
    setInterval(() => {
        loadSummary();
        loadTrades();
        loadPendingOrders();
        loadRiskMetrics();
        loadKSSSessions();
    }, 60000);
</script>
{% endblock %}
