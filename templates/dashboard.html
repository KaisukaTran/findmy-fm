{% extends "base.html" %}

{% block title %}Dashboard – FINDMY FM{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="display-5 fw-bold mb-2">
            <i class="fas fa-chart-line text-primary"></i> FINDMY FM Dashboard
        </h1>
        <p class="text-muted">Trade Service & Statement of Truth Monitor</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="card bg-light border-0">
            <div class="card-body">
                <p class="mb-0 text-muted small">Current Time</p>
                <p class="mb-0 fw-bold" id="current-time">—</p>
            </div>
        </div>
        <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- System Status Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-heartbeat"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-database fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">Database</p>
                            <p class="fw-bold mb-0">✓ Connected</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-exchange-alt fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">Trade Service</p>
                            <p class="fw-bold mb-0">✓ Active</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">SOT Audit</p>
                            <p class="fw-bold mb-0">✓ Ready</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            <p class="mb-0 text-muted">Last Update</p>
                            <p class="fw-bold mb-0" id="last-update">—</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Section -->
<div class="row mb-4" id="summary-cards">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Trades</p>
                <p class="display-6 fw-bold text-primary mb-0" id="total-trades">0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Realized P&L</p>
                <p class="display-6 fw-bold mb-0" id="realized-pnl" style="color: inherit;">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Unrealized P&L</p>
                <p class="display-6 fw-bold mb-0" id="unrealized-pnl" style="color: inherit;">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Equity</p>
                <p class="display-6 fw-bold text-success mb-0" id="total-equity">$0.00</p>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Invested</p>
                <p class="display-6 fw-bold text-info mb-0" id="total-invested">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Market Value</p>
                <p class="display-6 fw-bold text-primary mb-0" id="total-market-value">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small"><i class="fas fa-coins"></i> Price Source</p>
                <p class="fw-bold mb-0 small" id="price-source">Binance (live)</p>
            </div>
        </div>
    </div>
</div>

<!-- Positions Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> Current Positions</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Symbol</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Avg Price</th>
                                <th class="text-end">Total Cost</th>
                                <th class="text-end">Current Price</th>
                                <th class="text-end">Market Value</th>
                                <th class="text-end">Unrealized P&L</th>
                            </tr>
                        </thead>
                        <tbody id="positions-tbody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading positions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-positions" class="alert alert-info m-3 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No open positions yet.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trade History Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> Trade History (Recent 50)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Timestamp</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Price</th>
                                <th>Status</th>
                                <th class="text-end">Realized P&L</th>
                            </tr>
                        </thead>
                        <tbody id="trades-tbody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading trade history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-trades" class="alert alert-info m-3 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No trades yet. Upload an Excel file to execute orders.
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Update current time
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString();
    }
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    // Format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(value);
    }

    // Format date/time
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
    }

    // Load summary data
    async function loadSummary() {
        try {
            const response = await fetch('/api/summary');
            const data = await response.json();
            
            document.getElementById('total-trades').textContent = data.total_trades;
            
            const realizedColor = data.realized_pnl >= 0 ? '#28a745' : '#dc3545';
            const realizedElement = document.getElementById('realized-pnl');
            realizedElement.textContent = formatCurrency(data.realized_pnl);
            realizedElement.style.color = realizedColor;
            
            const unrealizedColor = data.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
            const unrealizedElement = document.getElementById('unrealized-pnl');
            unrealizedElement.textContent = formatCurrency(data.unrealized_pnl);
            unrealizedElement.style.color = unrealizedColor;
            
            document.getElementById('total-invested').textContent = formatCurrency(data.total_invested);
            document.getElementById('total-market-value').textContent = formatCurrency(data.total_market_value);
            
            const equityColor = data.total_equity >= data.total_invested ? '#28a745' : '#dc3545';
            const equityElement = document.getElementById('total-equity');
            equityElement.textContent = formatCurrency(data.total_equity);
            equityElement.style.color = equityColor;
            
            if (data.last_trade_time) {
                document.getElementById('last-update').textContent = formatDateTime(data.last_trade_time);
            } else {
                document.getElementById('last-update').textContent = '—';
            }
        } catch (error) {
            console.error('Error loading summary:', error);
        }
    }

    // Load positions data
    async function loadPositions() {
        try {
            const response = await fetch('/api/positions');
            const positions = await response.json();
            
            const tbody = document.getElementById('positions-tbody');
            const noPositions = document.getElementById('no-positions');
            
            if (positions.length === 0) {
                tbody.innerHTML = '';
                noPositions.style.display = 'block';
            } else {
                noPositions.style.display = 'none';
                tbody.innerHTML = positions.map(pos => {
                    const pnlColor = pos.unrealized_pnl !== null && pos.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                    const pnlText = pos.unrealized_pnl !== null ? formatCurrency(pos.unrealized_pnl) : '—';
                    const marketValueText = pos.market_value !== null ? formatCurrency(pos.market_value) : '—';
                    const currentPriceText = pos.current_price !== null ? formatCurrency(pos.current_price) : '—';
                    
                    return `
                        <tr>
                            <td><strong>${pos.symbol}</strong></td>
                            <td class="text-end">${pos.quantity.toFixed(8)}</td>
                            <td class="text-end">${formatCurrency(pos.avg_price)}</td>
                            <td class="text-end"><strong>${formatCurrency(pos.total_cost)}</strong></td>
                            <td class="text-end">${currentPriceText}</td>
                            <td class="text-end">${marketValueText}</td>
                            <td class="text-end" style="color: ${pnlColor};"><strong>${pnlText}</strong></td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading positions:', error);
        }
    }

    // Load trades data
    async function loadTrades() {
        try {
            const response = await fetch('/api/trades');
            const trades = await response.json();
            
            const tbody = document.getElementById('trades-tbody');
            const noTrades = document.getElementById('no-trades');
            
            if (trades.length === 0) {
                tbody.innerHTML = '';
                noTrades.style.display = 'block';
            } else {
                noTrades.style.display = 'none';
                tbody.innerHTML = trades.slice(0, 50).map(trade => {
                    const pnlColor = trade.realized_pnl !== null && trade.realized_pnl >= 0 ? '#28a745' : '#dc3545';
                    const pnlText = trade.realized_pnl !== null ? formatCurrency(trade.realized_pnl) : '—';
                    return `
                        <tr>
                            <td><small>${formatDateTime(trade.entry_time)}</small></td>
                            <td><strong>${trade.symbol}</strong></td>
                            <td>
                                <span class="badge ${trade.side === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                    ${trade.side}
                                </span>
                            </td>
                            <td class="text-end">${trade.entry_qty.toFixed(8)}</td>
                            <td class="text-end">${formatCurrency(trade.entry_price)}</td>
                            <td>
                                <span class="badge ${trade.status === 'OPEN' ? 'bg-warning' : (trade.status === 'CLOSED' ? 'bg-success' : 'bg-secondary')}">
                                    ${trade.status}
                                </span>
                            </td>
                            <td class="text-end" style="color: ${pnlColor};">
                                <strong>${pnlText}</strong>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading trades:', error);
        }
    }

    // Initial load
    loadSummary();
    loadPositions();
    loadTrades();

    // WebSocket connection for live updates (every 30 seconds from server)
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws/dashboard`);
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'dashboard_update') {
                    console.log('Received dashboard update:', data);
                    // Update positions from WebSocket
                    updatePositionsFromWebSocket(data.positions);
                    // Update summary from WebSocket
                    updateSummaryFromWebSocket(data.summary);
                }
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = function() {
            console.log('WebSocket closed, attempting to reconnect in 5 seconds...');
            setTimeout(connectWebSocket, 5000);
        };
    }
    
    // Update positions from WebSocket data
    function updatePositionsFromWebSocket(positions) {
        const tbody = document.getElementById('positions-tbody');
        const noPos = document.getElementById('no-positions');
        
        if (!positions || positions.length === 0) {
            tbody.innerHTML = '';
            noPos.style.display = 'block';
        } else {
            noPos.style.display = 'none';
            tbody.innerHTML = positions.map(pos => {
                const unrealizedColor = pos.unrealized_pnl !== null && pos.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                const unrealizedText = pos.unrealized_pnl !== null ? formatCurrency(pos.unrealized_pnl) : '—';
                const marketValueText = pos.market_value !== null ? formatCurrency(pos.market_value) : '—';
                const priceText = pos.current_price ? formatCurrency(pos.current_price) : '—';
                return `
                    <tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td class="text-end">${pos.quantity.toFixed(8)}</td>
                        <td class="text-end">${formatCurrency(pos.avg_price)}</td>
                        <td class="text-end">${formatCurrency(pos.total_cost)}</td>
                        <td class="text-end text-info"><strong>${priceText}</strong></td>
                        <td class="text-end text-info"><strong>${marketValueText}</strong></td>
                        <td class="text-end" style="color: ${unrealizedColor};"><strong>${unrealizedText}</strong></td>
                    </tr>
                `;
            }).join('');
        }
    }
    
    // Update summary from WebSocket data
    function updateSummaryFromWebSocket(summary) {
        const totalTradesEl = document.getElementById('total-trades');
        const realizedPnLEl = document.getElementById('realized-pnl');
        const unrealizedPnLEl = document.getElementById('unrealized-pnl');
        const totalInvestedEl = document.getElementById('total-invested');
        const totalMarketValueEl = document.getElementById('total-market-value');
        const totalEquityEl = document.getElementById('total-equity');
        
        if (totalTradesEl) totalTradesEl.textContent = summary.total_trades;
        if (realizedPnLEl) {
            realizedPnLEl.textContent = formatCurrency(summary.realized_pnl);
            realizedPnLEl.style.color = summary.realized_pnl >= 0 ? '#28a745' : '#dc3545';
        }
        if (unrealizedPnLEl) {
            unrealizedPnLEl.textContent = formatCurrency(summary.unrealized_pnl);
            unrealizedPnLEl.style.color = summary.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
        }
        if (totalInvestedEl) totalInvestedEl.textContent = formatCurrency(summary.total_invested);
        if (totalMarketValueEl) totalMarketValueEl.textContent = formatCurrency(summary.total_market_value);
        if (totalEquityEl) {
            totalEquityEl.textContent = formatCurrency(summary.total_equity);
            totalEquityEl.style.color = summary.total_equity >= 10000 ? '#28a745' : '#dc3545';
        }
    }

    // Connect WebSocket for live updates
    connectWebSocket();

    // Also keep polling every 60 seconds as fallback
    setInterval(() => {
        loadSummary();
        loadTrades();
    }, 60000);
</script>
{% endblock %}
