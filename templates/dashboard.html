{% extends "base.html" %}

{% block title %}Dashboard – FINDMY FM{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="display-5 fw-bold mb-2">
            <i class="fas fa-chart-line text-primary"></i> FINDMY FM Dashboard
        </h1>
        <p class="text-muted">Trade Service & Statement of Truth Monitor</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="card bg-light border-0">
            <div class="card-body">
                <p class="mb-0 text-muted small">Current Time</p>
                <p class="mb-0 fw-bold" id="current-time">—</p>
            </div>
        </div>
        <button class="btn btn-outline-primary mt-2" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- System Status Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-heartbeat"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-database fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">Database</p>
                            <p class="fw-bold mb-0">✓ Connected</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-exchange-alt fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">Trade Service</p>
                            <p class="fw-bold mb-0">✓ Active</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                            <p class="mb-0 text-muted">SOT Audit</p>
                            <p class="fw-bold mb-0">✓ Ready</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="status-item">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            <p class="mb-0 text-muted">Last Update</p>
                            <p class="fw-bold mb-0" id="last-update">—</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Summary Cards Section -->
<div class="row mb-4" id="summary-cards">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Trades</p>
                <p class="display-6 fw-bold text-primary mb-0" id="total-trades">0</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Realized P&L</p>
                <p class="display-6 fw-bold mb-0" id="realized-pnl" style="color: inherit;">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Unrealized P&L</p>
                <p class="display-6 fw-bold mb-0" id="unrealized-pnl" style="color: inherit;">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-0 shadow-sm">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Equity</p>
                <p class="display-6 fw-bold text-success mb-0" id="total-equity">$0.00</p>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Summary Cards -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Total Invested</p>
                <p class="display-6 fw-bold text-info mb-0" id="total-invested">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small">Market Value</p>
                <p class="display-6 fw-bold text-primary mb-0" id="total-market-value">$0.00</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-light">
            <div class="card-body text-center">
                <p class="mb-2 text-muted small"><i class="fas fa-coins"></i> Price Source</p>
                <p class="fw-bold mb-0 small" id="price-source">Binance (live)</p>
            </div>
        </div>
    </div>
</div>

<!-- Risk Metrics Card (v0.6.0) -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-danger text-white" style="opacity: 0.9;">
                <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Risk Metrics</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">Portfolio Exposure</span>
                            <span id="portfolio-exposure" class="fw-bold">0.0%</span>
                        </div>
                        <div class="progress">
                            <div id="exposure-bar" class="progress-bar bg-info" style="width: 0%"></div>
                        </div>
                        <small class="text-muted d-block mt-1">Max: 10.0% | Current: <span id="exposure-value">0.0%</span></small>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="text-muted">Today's Loss</span>
                            <span id="daily-loss" class="fw-bold text-danger">$0.00</span>
                        </div>
                        <div class="progress">
                            <div id="loss-bar" class="progress-bar bg-danger" style="width: 0%"></div>
                        </div>
                        <small class="text-muted d-block mt-1">Max Loss: 5.0% | Daily: <span id="daily-loss-pct">0.0%</span></small>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-top">
                    <p class="mb-1"><small><i class="fas fa-info-circle text-info"></i> <strong>Pip Multiplier:</strong> 2.0 (1 pip = 2 × min qty)</small></p>
                    <p class="mb-0"><small><i class="fas fa-info-circle text-info"></i> <strong>Position Limit:</strong> 10% equity | <strong>Daily Loss Limit:</strong> 5% equity</small></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Positions Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-list"></i> Current Positions</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Symbol</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Avg Price</th>
                                <th class="text-end">Total Cost</th>
                                <th class="text-end">Current Price</th>
                                <th class="text-end">Market Value</th>
                                <th class="text-end">Unrealized P&L</th>
                            </tr>
                        </thead>
                        <tbody id="positions-tbody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading positions...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-positions" class="alert alert-info m-3 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No open positions yet.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pending Orders Section (v0.5.0) -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-warning text-dark">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-hourglass-half"></i> Pending Orders Queue</h5>
                    <span class="badge bg-warning text-dark" id="pending-count">0</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Price</th>
                                <th>Order Type</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th class="text-center" style="width: 150px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-tbody">
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading pending orders...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-pending" class="alert alert-success m-3 mb-0" style="display: none;">
                    <i class="fas fa-check-circle"></i> No pending orders. All orders have been reviewed!
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Trade History Section -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-history"></i> Trade History (Recent 50)</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Timestamp</th>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th class="text-end">Quantity</th>
                                <th class="text-end">Price</th>
                                <th>Status</th>
                                <th class="text-end">Realized P&L</th>
                            </tr>
                        </thead>
                        <tbody id="trades-tbody">
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading trade history...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="no-trades" class="alert alert-info m-3 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No trades yet. Upload an Excel file to execute orders.
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Update current time
    function updateCurrentTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now.toLocaleString();
    }
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);

    // Format currency
    function formatCurrency(value) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD'
        }).format(value);
    }

    // Format date/time
    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString();
    }

    // Load summary data
    async function loadSummary() {
        try {
            const response = await fetch('/api/summary');
            const data = await response.json();
            
            document.getElementById('total-trades').textContent = data.total_trades;
            
            const realizedColor = data.realized_pnl >= 0 ? '#28a745' : '#dc3545';
            const realizedElement = document.getElementById('realized-pnl');
            realizedElement.textContent = formatCurrency(data.realized_pnl);
            realizedElement.style.color = realizedColor;
            
            const unrealizedColor = data.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
            const unrealizedElement = document.getElementById('unrealized-pnl');
            unrealizedElement.textContent = formatCurrency(data.unrealized_pnl);
            unrealizedElement.style.color = unrealizedColor;
            
            document.getElementById('total-invested').textContent = formatCurrency(data.total_invested);
            document.getElementById('total-market-value').textContent = formatCurrency(data.total_market_value);
            
            const equityColor = data.total_equity >= data.total_invested ? '#28a745' : '#dc3545';
            const equityElement = document.getElementById('total-equity');
            equityElement.textContent = formatCurrency(data.total_equity);
            equityElement.style.color = equityColor;
            
            if (data.last_trade_time) {
                document.getElementById('last-update').textContent = formatDateTime(data.last_trade_time);
            } else {
                document.getElementById('last-update').textContent = '—';
            }
        } catch (error) {
            console.error('Error loading summary:', error);
        }
    }

    // Load positions data
    async function loadPositions() {
        try {
            const response = await fetch('/api/positions');
            const positions = await response.json();
            
            const tbody = document.getElementById('positions-tbody');
            const noPositions = document.getElementById('no-positions');
            
            if (positions.length === 0) {
                tbody.innerHTML = '';
                noPositions.style.display = 'block';
            } else {
                noPositions.style.display = 'none';
                tbody.innerHTML = positions.map(pos => {
                    const pnlColor = pos.unrealized_pnl !== null && pos.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                    const pnlText = pos.unrealized_pnl !== null ? formatCurrency(pos.unrealized_pnl) : '—';
                    const marketValueText = pos.market_value !== null ? formatCurrency(pos.market_value) : '—';
                    const currentPriceText = pos.current_price !== null ? formatCurrency(pos.current_price) : '—';
                    
                    return `
                        <tr>
                            <td><strong>${pos.symbol}</strong></td>
                            <td class="text-end">${pos.quantity.toFixed(8)}</td>
                            <td class="text-end">${formatCurrency(pos.avg_price)}</td>
                            <td class="text-end"><strong>${formatCurrency(pos.total_cost)}</strong></td>
                            <td class="text-end">${currentPriceText}</td>
                            <td class="text-end">${marketValueText}</td>
                            <td class="text-end" style="color: ${pnlColor};"><strong>${pnlText}</strong></td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading positions:', error);
        }
    }

    // Load trades data
    async function loadTrades() {
        try {
            const response = await fetch('/api/trades');
            const trades = await response.json();
            
            const tbody = document.getElementById('trades-tbody');
            const noTrades = document.getElementById('no-trades');
            
            if (trades.length === 0) {
                tbody.innerHTML = '';
                noTrades.style.display = 'block';
            } else {
                noTrades.style.display = 'none';
                tbody.innerHTML = trades.slice(0, 50).map(trade => {
                    const pnlColor = trade.realized_pnl !== null && trade.realized_pnl >= 0 ? '#28a745' : '#dc3545';
                    const pnlText = trade.realized_pnl !== null ? formatCurrency(trade.realized_pnl) : '—';
                    return `
                        <tr>
                            <td><small>${formatDateTime(trade.entry_time)}</small></td>
                            <td><strong>${trade.symbol}</strong></td>
                            <td>
                                <span class="badge ${trade.side === 'BUY' ? 'bg-success' : 'bg-danger'}">
                                    ${trade.side}
                                </span>
                            </td>
                            <td class="text-end">${trade.entry_qty.toFixed(8)}</td>
                            <td class="text-end">${formatCurrency(trade.entry_price)}</td>
                            <td>
                                <span class="badge ${trade.status === 'OPEN' ? 'bg-warning' : (trade.status === 'CLOSED' ? 'bg-success' : 'bg-secondary')}">
                                    ${trade.status}
                                </span>
                            </td>
                            <td class="text-end" style="color: ${pnlColor};">
                                <strong>${pnlText}</strong>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading trades:', error);
        }
    }

    // Load pending orders data (v0.5.0)
    async function loadPendingOrders() {
        try {
            const response = await fetch('/api/pending');
            const orders = await response.json();
            
            const tbody = document.getElementById('pending-tbody');
            const noPending = document.getElementById('no-pending');
            const countBadge = document.getElementById('pending-count');
            
            // Count pending (not approved or rejected)
            const pendingOrders = orders.filter(o => o.status === 'pending');
            countBadge.textContent = pendingOrders.length;
            
            if (pendingOrders.length === 0) {
                tbody.innerHTML = '';
                noPending.style.display = 'block';
            } else {
                noPending.style.display = 'none';
                tbody.innerHTML = pendingOrders.map(order => {
                    const sideBadgeClass = order.side === 'BUY' ? 'bg-success' : 'bg-danger';
                    const statusBadgeClass = order.status === 'pending' ? 'bg-warning text-dark' : (order.status === 'approved' ? 'bg-success' : 'bg-danger');
                    return `
                        <tr>
                            <td><strong>${order.symbol}</strong></td>
                            <td>
                                <span class="badge ${sideBadgeClass}">
                                    ${order.side}
                                </span>
                            </td>
                            <td class="text-end">${order.quantity}</td>
                            <td class="text-end">${formatCurrency(order.price)}</td>
                            <td><small>${order.order_type || 'LIMIT'}</small></td>
                            <td><small>${order.source || 'manual'}</small></td>
                            <td>
                                <span class="badge ${statusBadgeClass}">
                                    ${order.status}
                                </span>
                            </td>
                            <td><small>${formatDateTime(order.created_at)}</small></td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-success" onclick="approvePendingOrder(${order.id}, '${order.symbol}')" title="Approve order">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="rejectPendingOrder(${order.id}, '${order.symbol}')" title="Reject order">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        } catch (error) {
            console.error('Error loading pending orders:', error);
        }
    }

    // Approve pending order (v0.5.0)
    async function approvePendingOrder(orderId, symbol) {
        if (!confirm(`Approve order for ${symbol}?`)) return;
        
        try {
            const response = await fetch(`/api/pending/approve/${orderId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            if (response.ok) {
                console.log(`Order ${orderId} approved`);
                loadPendingOrders();
                // Refresh positions and trades after approval
                loadPositions();
                loadTrades();
                loadSummary();
            } else {
                alert('Failed to approve order');
            }
        } catch (error) {
            console.error('Error approving order:', error);
            alert('Error approving order');
        }
    }

    // Reject pending order (v0.5.0)
    async function rejectPendingOrder(orderId, symbol) {
        const reason = prompt(`Reject order for ${symbol}? (Enter reason):`, 'Market conditions changed');
        if (reason === null) return;
        
        try {
            const response = await fetch(`/api/pending/reject/${orderId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({reason: reason || 'User rejected'})
            });
            
            if (response.ok) {
                console.log(`Order ${orderId} rejected`);
                loadPendingOrders();
            } else {
                alert('Failed to reject order');
            }
        } catch (error) {
            console.error('Error rejecting order:', error);
            alert('Error rejecting order');
        }
    }

    // Load risk metrics (v0.6.0)
    async function loadRiskMetrics() {
        try {
            // For now, use mock data (in production, fetch from /api/risk endpoint)
            // Portfolio exposure: 5% of equity
            const portfolioExposure = 5.0;
            const maxExposure = 10.0;
            
            // Daily loss: $250 (2.5% of $10k)
            const dailyLoss = 250.0;
            const dailyLossPct = 2.5;
            const maxDailyLoss = 5.0;

            // Update exposure display
            document.getElementById('portfolio-exposure').textContent = portfolioExposure.toFixed(1) + '%';
            document.getElementById('exposure-value').textContent = portfolioExposure.toFixed(1) + '%';
            document.getElementById('exposure-bar').style.width = (portfolioExposure / maxExposure * 100) + '%';
            
            // Color exposure bar based on percentage
            const exposureBar = document.getElementById('exposure-bar');
            if (portfolioExposure > maxExposure * 0.8) {
                exposureBar.className = 'progress-bar bg-danger';
            } else if (portfolioExposure > maxExposure * 0.5) {
                exposureBar.className = 'progress-bar bg-warning';
            } else {
                exposureBar.className = 'progress-bar bg-info';
            }

            // Update daily loss display
            document.getElementById('daily-loss').textContent = formatCurrency(dailyLoss);
            document.getElementById('daily-loss-pct').textContent = dailyLossPct.toFixed(1) + '%';
            document.getElementById('loss-bar').style.width = (dailyLossPct / maxDailyLoss * 100) + '%';
            
            // Color loss bar based on percentage
            const lossBar = document.getElementById('loss-bar');
            if (dailyLossPct > maxDailyLoss * 0.8) {
                lossBar.className = 'progress-bar bg-danger';
            } else if (dailyLossPct > maxDailyLoss * 0.5) {
                lossBar.className = 'progress-bar bg-warning';
            } else {
                lossBar.className = 'progress-bar bg-success';
            }
        } catch (error) {
            console.error('Error loading risk metrics:', error);
        }
    }

    // Initial load
    loadSummary();
    loadPositions();
    loadPendingOrders();
    loadTrades();
    loadRiskMetrics();

    // WebSocket connection for live updates (every 30 seconds from server)
    function connectWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws/dashboard`);
        
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'dashboard_update') {
                    console.log('Received dashboard update:', data);
                    // Update positions from WebSocket
                    updatePositionsFromWebSocket(data.positions);
                    // Update summary from WebSocket
                    updateSummaryFromWebSocket(data.summary);
                }
            } catch (error) {
                console.error('Error parsing WebSocket message:', error);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = function() {
            console.log('WebSocket closed, attempting to reconnect in 5 seconds...');
            setTimeout(connectWebSocket, 5000);
        };
    }
    
    // Update positions from WebSocket data
    function updatePositionsFromWebSocket(positions) {
        const tbody = document.getElementById('positions-tbody');
        const noPos = document.getElementById('no-positions');
        
        if (!positions || positions.length === 0) {
            tbody.innerHTML = '';
            noPos.style.display = 'block';
        } else {
            noPos.style.display = 'none';
            tbody.innerHTML = positions.map(pos => {
                const unrealizedColor = pos.unrealized_pnl !== null && pos.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                const unrealizedText = pos.unrealized_pnl !== null ? formatCurrency(pos.unrealized_pnl) : '—';
                const marketValueText = pos.market_value !== null ? formatCurrency(pos.market_value) : '—';
                const priceText = pos.current_price ? formatCurrency(pos.current_price) : '—';
                return `
                    <tr>
                        <td><strong>${pos.symbol}</strong></td>
                        <td class="text-end">${pos.quantity.toFixed(8)}</td>
                        <td class="text-end">${formatCurrency(pos.avg_price)}</td>
                        <td class="text-end">${formatCurrency(pos.total_cost)}</td>
                        <td class="text-end text-info"><strong>${priceText}</strong></td>
                        <td class="text-end text-info"><strong>${marketValueText}</strong></td>
                        <td class="text-end" style="color: ${unrealizedColor};"><strong>${unrealizedText}</strong></td>
                    </tr>
                `;
            }).join('');
        }
    }
    
    // Update summary from WebSocket data
    function updateSummaryFromWebSocket(summary) {
        const totalTradesEl = document.getElementById('total-trades');
        const realizedPnLEl = document.getElementById('realized-pnl');
        const unrealizedPnLEl = document.getElementById('unrealized-pnl');
        const totalInvestedEl = document.getElementById('total-invested');
        const totalMarketValueEl = document.getElementById('total-market-value');
        const totalEquityEl = document.getElementById('total-equity');
        
        if (totalTradesEl) totalTradesEl.textContent = summary.total_trades;
        if (realizedPnLEl) {
            realizedPnLEl.textContent = formatCurrency(summary.realized_pnl);
            realizedPnLEl.style.color = summary.realized_pnl >= 0 ? '#28a745' : '#dc3545';
        }
        if (unrealizedPnLEl) {
            unrealizedPnLEl.textContent = formatCurrency(summary.unrealized_pnl);
            unrealizedPnLEl.style.color = summary.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
        }
        if (totalInvestedEl) totalInvestedEl.textContent = formatCurrency(summary.total_invested);
        if (totalMarketValueEl) totalMarketValueEl.textContent = formatCurrency(summary.total_market_value);
        if (totalEquityEl) {
            totalEquityEl.textContent = formatCurrency(summary.total_equity);
            totalEquityEl.style.color = summary.total_equity >= 10000 ? '#28a745' : '#dc3545';
        }
    }

    // Connect WebSocket for live updates
    connectWebSocket();

    // Also keep polling every 60 seconds as fallback
    setInterval(() => {
        loadSummary();
        loadTrades();
        loadPendingOrders();
        loadRiskMetrics();
    }, 60000);
</script>
{% endblock %}
